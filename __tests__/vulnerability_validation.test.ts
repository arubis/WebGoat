

import { describe, it, expect, vi } from 'vitest';
import fs from 'fs';
import path from 'path';

describe('SQL Injection Prevention in CustomGoat.getFlights()', function() {
  it('should not include unescaped SQL injection payload in XML output', function() {
    const injectionPayload = "' OR '1'='1";
    
    const mockFromField = {
      value: vi.fn().mockReturnValue(injectionPayload)
    };
    const mockToField = {
      value: vi.fn().mockReturnValue("destination")
    };
    
    const mockJQuery = vi.fn((selector) => {
      if (selector === '#travelFrom') return mockFromField;
      if (selector === '#travelTo') return mockToField;
      return { value: () => '' };
    });
    
    let customGoatModule;
    const mockDefine = (deps, factory) => {
      customGoatModule = factory(mockJQuery, {}, {}, {});
    };
    mockDefine.amd = true;
    
    const originalDefine = global.define;
    global.define = mockDefine;
    
    try {
      const sourceCode = fs.readFileSync(
        path.join(process.cwd(), 'src/main/resources/webgoat/static/js/goatApp/support/CustomGoat.js'),
        'utf8'
      );
      eval(sourceCode);
      
      const result = customGoatModule.getFlights();
      
      expect(result).not.toContain(injectionPayload);
    } finally {
      global.define = originalDefine;
    }
  });
});