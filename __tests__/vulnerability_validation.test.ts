

import { describe, it, expect, vi } from 'vitest';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

describe('SQL Injection Prevention - CustomGoat.getFlights()', () => {
  it('should not allow XML injection through travelFrom field', async () => {
    const maliciousPayload = "NYC</from><injected>MALICIOUS</injected><from>";
    let capturedModule;

    const mockJQuery = vi.fn((selector) => {
      if (selector === '#travelFrom') {
        return {
          value: () => maliciousPayload
        };
      }
      if (selector === '#travelTo') {
        return {
          value: () => 'LAX'
        };
      }
      return { value: () => '' };
    });

    global.define = vi.fn((deps, factory) => {
      capturedModule = factory(mockJQuery, {}, {}, {});
    });
    global.define.amd = true;

    await import(path.join(process.cwd(), 'src/main/resources/webgoat/static/js/goatApp/support/CustomGoat.js'));

    const xmlOutput = capturedModule.getFlights();

    expect(xmlOutput).not.toContain('<injected>MALICIOUS</injected>');
    expect(xmlOutput).not.toMatch(/<from>.*<\/from>.*<injected>/);
  });
});