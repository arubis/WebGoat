

import { describe, it, expect, vi, beforeEach } from 'vitest';
import path from 'path';
import fs from 'fs';

describe('SQL/XML Injection Prevention - CustomGoat.getFlights()', () => {
  let customGoat;
  
  beforeEach(() => {
    // Mock the AMD define() function to capture and execute the factory
    const mockJQuery = vi.fn((selector) => {
      return {
        value: vi.fn(() => mockJQuery.mockValue || '')
      };
    });
    mockJQuery.mockValue = '';
    
    global.define = vi.fn((deps, factory) => {
      customGoat = factory(mockJQuery, {}, {}, {});
    });
    global.define.amd = true;
    
    // Load the vulnerable module
    const sourceCode = fs.readFileSync(
      path.join(process.cwd(), 'src/main/resources/webgoat/static/js/goatApp/support/CustomGoat.js'),
      'utf8'
    );
    
    // Execute the module code to trigger define()
    eval(sourceCode);
    
    // Store reference to jQuery mock for test manipulation
    customGoat._mockJQuery = mockJQuery;
  });

  it('should not include unsanitized SQL injection payload in XML output', () => {
    // Arrange: Set up malicious input in the mocked form fields
    const maliciousInput = "' OR '1'='1";
    const mockFrom = { value: () => maliciousInput };
    const mockTo = { value: () => 'destination' };
    
    // Mock jQuery to return our malicious input
    global.$ = vi.fn((selector) => {
      if (selector === '#travelFrom') return mockFrom;
      if (selector === '#travelTo') return mockTo;
      return { value: () => '' };
    });
    
    // Re-evaluate to get fresh instance with new $ mock
    const sourceCode = fs.readFileSync(
      path.join(process.cwd(), 'src/main/resources/webgoat/static/js/goatApp/support/CustomGoat.js'),
      'utf8'
    );
    let testCustomGoat;
    global.define = vi.fn((deps, factory) => {
      testCustomGoat = factory(global.$, {}, {}, {});
    });
    eval(sourceCode);
    
    // Act: Call the vulnerable function
    const xmlOutput = testCustomGoat.getFlights();
    
    // Assert: The malicious payload should NOT appear unescaped in the XML
    // This assertion FAILS on vulnerable code (RED test) because the payload IS present
    expect(xmlOutput).not.toContain("' OR '1'='1");
  });
});