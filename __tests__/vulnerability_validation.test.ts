

import { describe, it, expect } from 'vitest';
import path from 'path';
import fs from 'fs';

describe('SQL Injection Prevention - CustomGoat.getFlights()', () => {
  it('should not include unescaped user input in XML query', () => {
    // Mock the AMD define function to capture the module factory
    let moduleFactory;
    global.define = (deps, factory) => {
      moduleFactory = factory;
    };
    global.define.amd = true;

    // Mock jQuery object with a value() method that returns malicious input
    const maliciousInput = "' OR '1'='1";
    const mockFromField = {
      value: () => maliciousInput
    };
    const mockToField = {
      value: () => 'destination'
    };
    
    const mockJQuery = (selector) => {
      if (selector === '#travelFrom') return mockFromField;
      if (selector === '#travelTo') return mockToField;
      return {};
    };

    // Load the vulnerable module
    const sourceCode = fs.readFileSync(
      path.join(process.cwd(), 'src/main/resources/webgoat/static/js/goatApp/support/CustomGoat.js'),
      'utf8'
    );
    eval(sourceCode);

    // Execute the factory with mocked dependencies
    const customGoat = moduleFactory(mockJQuery, {}, {}, {});

    // Call the vulnerable function
    const result = customGoat.getFlights();

    // RED TEST: Assert that malicious payload should NOT appear unescaped
    // This FAILS on vulnerable code because the payload IS present unescaped
    expect(result).not.toContain("' OR '1'='1");
  });
});